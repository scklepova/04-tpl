# HTTP-балансировщик

На базе кода асинхронного Proxy-сервера, который мы писали на занятии, необходимо реализовать Balancer - балансировщик http-запросов. Он должен уметь:

* Читать топологию кластера однотипных серверов, умеющих отвечать на http GET-запросы на url-ы вида:
http://\<server\>:\<port\>/method?query=\<q\> Топология задается в файле настроек как построчное перечисление записей вида host:port. Пример содержимого файла настроек:
```
127.0.0.1:20000
localhost:20001
127.0.0.1:20002
```
* Слушать http-префикс /method и при получении запроса от клиента, случайным образом выбирать любую реплику кластера и проксировать запрос клиента на нее. Например:
```
http://<balancer_ip>:<balancer_port>/method?qqq=lalala
```
должен проксироваться на одну из случайно выбранных реплик, например
```
http://127.0.0.1:20001/method?qqq=lalala
```
* В случае ошибки (отсутствия соединения до реплики, сетевой ошибки при передаче данных, возврата репликой 500-го HTTP-кода ошибки, …), а также в случае таймаута ожидания ответа от реплики сервера, балансировщик должен выбирать следующую случайную реплику и повторять запрос к ней. Повторять до тех пор, пока какая-нибудь реплика успешно не ответит. Если ни одна реплика так и не ответит успешно на запрос, балансировщик должен вернуть клиенту HTTP-код ошибки 500.
* В случае, если клиент в HTTP-заголовке _Accept-Encoding_ передает значение **deflate** (то есть сообщает балансировщику, что поддерживает сжатие передаваемых данных алгоритмом deflate), балансировщик перед тем как отдавать результат обработки запроса клиенту, должен осуществлять сжатие ответа реплики кластера, например, с помощью DeflateStream-а, не забывая указывать о примененном deflate-сжатии клиенту с помощью HTTP-заголовка _Content-Encoding_ в ответе.
* По желанию, можно реализовать алгоритм “серых списков”, когда балансировщик запоминает на некоторое время, что реплика не ответила успешно и в течение этого времени не делает запросов к этой реплике, чтобы не тратить зря время на таймаут. В случае, если все реплики кластера попадают в серый список, а от клиента приходит запрос, балансировщик должен все же попытаться получить ответ хоть от какой-нибудь реплики из серого списка.
